<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notices</title>
    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="/css/fontawesome-free-5.15.3-web/css/all.css" rel="stylesheet">
    <meta name="color-scheme" content="dark">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="app container">
    <div class="content" style ="display: none">
        <button class="signout btn btn-dark" style="top: 5px; right: 20px; position: absolute">Log out</button>
        <div class="chat-app"></div>
    </div>
</div>

<script type="module">
    import FrameComponent from "./app/components/frame.js";
    import UserComponent from "./app/components/user.js";
    import UserListComponent from "./app/components/userlist.js";
    import MessageComponent from "./app/components/message.js";
    import MessageListComponent from "./app/components/messagelist.js";
    import LoginComponent from "./app/components/login.js";
    import LogoutComponent from "./app/components/logout.js";

    let currentUserId = null;
    let selectedReceiverId = null;


    const eventSourcedMessages = new EventSource('/api/messages_event_source.php?sender_id=1&receiver_id=3')
    eventSourcedMessages.onmessage = function(event) {
        console.log(event.data);
        console.log(typeof(event.data))
        console.log(event.data.split())
    }

    document.addEventListener('app-mounted', e => {

    });

    document.addEventListener('user-logged-in', e => {
         fetch(`/api/users.php?logged_in_user_id=${localStorage.getItem('currentUserId')}`).then( response => {
            if (response.status === 200) {
                return  response.text();
            }
            throw new Error('could not fetch data');
        })
            .then(json => {
                const userList = new UserListComponent.UserList()
                UserListComponent.mount(document.querySelector('.contacts-box'),userList.fromJSON(json))
            });
    });



    document.addEventListener('user-selected', e => {
        fetch(`/api/messages.php?sender_id=${localStorage.getItem('currentUserId')}&receiver_id=${e.detail}`).then( response => {
            if (response.status === 200) {
                return  response.text();
            }
            throw new Error('could not fetch data');
        })
            .then(json => {
                const messageList = new MessageListComponent.MessageList()
                MessageListComponent.mount(document.querySelector('.chat-box'),messageList.fromJSON(json))
            });
    });


    FrameComponent.mount(document.querySelector('.chat-app'))
    LoginComponent.mount(document.querySelector('.app'));
    LogoutComponent.mount(document.querySelector('.app'));



   //  import App from "./app.js";

   // new App(document.querySelector('.app'));




</script>
</body>
</html>